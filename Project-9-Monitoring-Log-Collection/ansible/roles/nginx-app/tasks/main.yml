---
- name: Update apt cache
  shell: apt-get update
  become: yes
  changed_when: false

- name: Install Nginx
  shell: apt-get install -y nginx
  become: yes

- name: Enable and start Nginx
  service:
    name: nginx
    state: started
    enabled: yes
  become: yes

- name: Create health check endpoint
  copy:
    content: |
      server {
          listen 80 default_server;
          listen [::]:80 default_server;

          server_name _;

          location /health {
              access_log off;
              return 200 "OK\n";
              add_header Content-Type text/plain;
          }

          location / {
              root /var/www/html;
              index index.html;
          }

          access_log /var/log/nginx/access.log;
          error_log /var/log/nginx/error.log;
      }
    dest: /etc/nginx/sites-available/default
  become: yes
  notify: restart nginx

- name: Create home page
  copy:
    content: |
      <!DOCTYPE html>
      <html>
      <head>
          <title>App Server</title>
      </head>
      <body>
          <h1>{{ inventory_hostname }} - Healthy</h1>
          <p>This is app server: {{ inventory_hostname }}</p>
          <p>Private IP: {{ ansible_default_ipv4.address }}</p>
      </body>
      </html>
    dest: /var/www/html/index.html
  become: yes

- name: Check if nginx logs exist
  file:
    path: /var/log/nginx/{{ item }}
    state: touch
  become: yes
  loop:
    - access.log
    - error.log
